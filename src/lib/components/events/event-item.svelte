<script lang="ts">
  import { onMount } from 'svelte';
  import type { AcmEvent } from '$lib/ical';
  import { toast, ToastType } from '$lib/stores/toasts';
  import CopyLinkIcon from '$lib/components/icons/copy-link.svelte';
  import CopyTextIcon from '$lib/components/icons/copy-text.svelte';
  import GoogleCalendarIcon from '$lib/components/icons/google-calendar.svelte';
  import MsOutlookIcon from '$lib/components/icons/ms-outlook.svelte';

  export let info: AcmEvent;

  let isRecurring: boolean = info.recurring;
  let anchor: HTMLElement;
  let details: HTMLDetailsElement;

  /** @see <https://developer.mozilla.org/en-US/docs/Web/API/Clipboard/writeText> */
  function copy(link: string, successMessage: string, errorMessage: string, path: string) {
    navigator.clipboard
      .writeText(link)
      .then(() => toast({ content: successMessage, path }))
      .catch(() => toast({ path, type: ToastType.Error, content: errorMessage }));
  }

  onMount(() => {
    if (location.hash === `#${info.slug}`) {
      anchor.scrollIntoView({
        behavior: 'smooth',
        block: 'start',
        inline: 'center',
      });

      // This has the same styling as :target, and :target doesn't want to work
      // for dynamically-added elements.
      details.open = true;
    }
  });
</script>

<div class="event-box" style:--highlights={`var(--acm-${info.acmPath.slug}-rgb)`}>
  <!-- Workaround for the top panel covering the event card's anchor. -->
  <div class="anchor" id={info.slug} bind:this={anchor} />

  <details class="event-card" bind:this={details}>
    <summary class="event-body">
      <div class="event-name">
        <h2 class="headers">
          {info.title}
        </h2>

        <p class="event-location brand-med acm-gray">
          {#if info.location == 'Discord'}
            TBA
          {:else}
            {info.location}
          {/if}
        </p>
      </div>

      <p class="event-date">
        <!-- TODO: RFC3339 timestamp for datetime -->
        <time>
          {info.month}
          {info.day} at {info.time}
          {#if isRecurring}<br />Recurring{/if}
        </time>
      </p>

      <a
        class="event-join size-sm brand-header"
        href={info.meetingLink}
        role="button"
        target="_blank"
        rel="noopener noreferrer">Join</a
      >
    </summary>

    <hr />

    <p class="event-description">
      {@html info.description}
    </p>

    <div class="event-actionbar">
      <button
        class="action-item"
        title="Copy event link"
        on:click={() =>
          copy(
            info.selfLink,
            'Copied event link to clipboard!',
            'Failed to copy event link to clipboard!',
            info.acmPath.slug
          )}
      >
        <CopyLinkIcon />
      </button>

      <button
        class="action-item"
        title="Copy event summary"
        on:click={() =>
          copy(
            info.summary,
            'Copied event summary to clipboard!',
            'Failed to copy event summary to clipboard!',
            info.acmPath.slug
          )}
      >
        <CopyTextIcon />
      </button>

      <button
        class="action-item"
        title="Copy Google Calendar link"
        on:click={() =>
          copy(
            info.calendarLinks.google,
            'Copied Google Calendar link to clipboard!',
            'Failed to copy Google Calendar link to clipboard!',
            info.acmPath.slug
          )}
      >
        <GoogleCalendarIcon />
      </button>

      <button
        class="action-item"
        title="Copy Microsoft Outlook calendar link"
        on:click={() =>
          copy(
            info.calendarLinks.outlook,
            'Copied Microsoft Outlook calendar link to clipboard!',
            'Failed to copy Microsoft Outlook calendar link to clipboard!',
            info.acmPath.slug
          )}
      >
        <MsOutlookIcon />
      </button>
    </div>
  </details>
</div>

<style lang="scss">
  .event-box {
    position: relative;

    & > .anchor {
      visibility: hidden;
      position: absolute;
      /* 200px from the top of the screen for the anchor workaround. */
      top: -200px;
    }

    .event-card {
      margin: 32px 64px;
      background-color: var(--card-bg);
      box-shadow: 0 6px 18px rgba(var(--highlights, --acm-general-rgb), 0.5);
      transition: 0.25s ease-in-out;
      border-radius: 20px;

      .event-body {
        /* Do this whole dance so the user can click on the padding. */
        padding: 24px 30px;
        cursor: pointer;
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;

        .event-name {
          flex: 1;
          text-align: left;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          margin-right: 16px;

          h2 {
            position: relative;
            line-height: 1.2em;
            user-select: none;
            color: var(--acm-dark);
            transition: 0.25s ease-in-out;
          }

          .event-location:not(:empty) {
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--acm-dark);
            /* Required for ellipsizing. */
            max-width: 300px;
          }
        }

        .event-date {
          flex: 0;
          user-select: none;
          text-align: right;
          white-space: nowrap;
          margin-right: 16px;
        }

        .event-join {
          margin: 0;
          padding: 12px 24px;
          text-decoration: none;
          text-align: center;
          border-radius: 12px;
          background-color: #101315;
          color: var(--perma-light);
          transition: background-color 0.25s ease-in-out;
        }

        &:hover {
          .event-name h2 {
            color: rgb(var(--highlights, --acm-general-rgb));
          }

          .event-join:hover {
            background-color: rgb(var(--highlights, --acm-general-rgb));
          }
        }
      }

      hr {
        border-width: 0.5px;
        border-radius: 8px;
        border-color: var(--acm-gray);
        background-color: var(--acm-gray);
        margin: 0 30px;
      }

      .event-description {
        margin: 24px 30px;
        overflow-wrap: break-word;

        &:empty::after {
          content: 'No description.';
          opacity: 0.75;
          font-style: italic;
        }
      }

      .event-actionbar {
        display: flex;
        flex-direction: row-reverse;
        padding: 0 2em 2em 2em;
        gap: 1.5em;

        .action-item {
          --size: 40px;
          color: var(--highlights);
          width: var(--size);
          height: var(--size);
          padding: calc(var(--size) * 0.25);
          box-shadow: 0 3px 9px rgba(var(--highlights, --acm-general-rgb), 0.5);
          transition: 0.25s ease-in-out;
          border-radius: 50%;
          border: none;
          background-color: var(--acm-light);

          &:hover {
            transform: scale(1.1);
            cursor: pointer;
            box-shadow: 0 3px 18px rgba(var(--highlights, --acm-general-rgb), 0.3);
          }
        }
      }

      &:hover,
      &[open] {
        transform: scale(1.05);
        box-shadow: 0 6px 36px rgba(var(--highlights, --acm-general-rgb), 0.3);

        .event-body .event-name h2 {
          color: rgb(var(--highlights, --acm-general-rgb));
        }
      }

      & > .anchor:target + .event-card {
        box-shadow: 0 6px 36px rgba(var(--highlights, --acm-general-rgb), 0.3);
      }
    }
  }

  @media screen and (max-width: 900px) {
    .event-box .event-card {
      margin: 32px 8px;

      .event-body {
        flex-direction: column;

        .event-name {
          text-align: center;
          margin-right: 0;
          align-items: center;
        }

        .event-date {
          margin-top: 10px;
          margin-bottom: 12px;
          margin-right: 0;
          text-align: center;
        }
      }

      .event-actionbar {
        justify-content: center;
        gap: 0.75em;
      }

      &:hover,
      &[open] {
        transform: unset;
      }
    }
  }
</style>
